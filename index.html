<html>

<head>
  <title>Melodle</title>
  <link rel="icon" type="image/x-icon" href="https://i.imgur.com/W0hSLN9.png">
  <style>
  	body {
  		font-family: Helvetica;
  		background-color: #f6f6f6;
  	}

    table {
	    border-collapse: collapse;
	    width: 100%;
	    
	}

	tr {
		height: 50px;
	}

	td,
	th {
	    border: 1px solid #000000;
	    text-align: left;
	    padding-left: 2%;
	    font-size: 22px;
	}

    .switcher {
      display: inline-flex;
      flex-direction: row;
      padding: 10px;
      justify-content: space-between;
      flex-grow: 1;
      width: 50%;
    }

    #completed-text {
    	margin: auto;
    	font-size: 28px;
    	text-align: center;
    }

    .container {
		position: absolute;
		margin: auto;
		display: inline-flex;
		width: 1000px;
	    height: 68%;
	    min-height: 900px;
	    flex-direction: column;
	    
	    padding-top: 6%;
		left: 50%;
		transform: translate(-50%);
    }

    .container-row {
    	width: 90%;
    	min-height: 70px;
    	display: inline-flex;
    	flex-direction: row;
    	padding: 10px;
    	justify-content: space-between;
    }

    #main-section-1 {
    	padding-top:3%;
    }

    #main-section-2 {
    	flex-grow: 1;
    	padding-top: 7%;
    	padding-bottom: 5%;
    }

    #main-section-completed {
    	display: none;
    }

    form {
    	flex-grow: 1;
    	padding-right: 5%;
	   	padding-top: 10px;
    }

    .form-input {
    	float: right;
    	width: 75px;
    	height: 50px;
    }

    #myInput {
	   	height: 50px;
    }

    button {
      min-width: max-content;
      min-height: max-content;
      width: 130px;
      height: 70px;
      margin-left: 1%;
      margin-right: 1%;
      border-radius: 10px;
      border: 0;
      background: #191414;
      color: #fff;
      font-size: 15;
      cursor: pointer;
    }

    .arrowbutton {
    	min-width: max-content;
      min-height: max-content;
      width: 80px;
      height: 30px;
      margin-left: 1%;
      margin-right: 1%;
      border-radius: 10px;
      border: 0;
      background: #191414;
      color: #fff;
      font-size: 15;
      cursor: pointer;
      flex: 1;
    }

    .arrowbuttons {
    	display: flex;
    	width: 38%;
    	margin-left: auto;
    	vertical-align: center;
    }

    .songselectiongrid {
    	display: flex;
    	flex-direction: column;
    	flex-grow: 1;
    }

    .playBtn:hover {
      background: #1Db954;
    }

    .autocomplete {
	  /*the container must be positioned relative:*/
	  position: relative;
	  display: inline-block;
	  width: 100%;
	}
	input {
	  border: 1px solid #000;
	  background-color: #f1f1f1;
	  padding: 10px;
	  font-size: 16px;
	}
	input[type=text] {
	  background-color: #f1f1f1;
	  width: 100%;
	}
	.autocomplete-items {
	  position: absolute;
	  border: 1px solid #d4d4d4;
	  border-bottom: none;
	  border-top: none;
	  z-index: 99;
	  /*position the autocomplete items to be the same width as the container:*/
	  top: 100%;
	  left: 0;
	  right: 0;
	}
	.autocomplete-items div {
	  padding: 10px;
	  cursor: pointer;
	  background-color: #fff;
	  border-bottom: 1px solid #d4d4d4;
	}
	.autocomplete-items div:hover {
	  /*when hovering an item:*/
	  background-color: #e9e9e9;
	}
	.autocomplete-active {
	  /*when navigating through the items using the arrow keys:*/
	  background-color: DodgerBlue !important;
	  color: #ffffff;
	}

	.progressbar {
	  width: 80%;
	  padding-top: 15px;
	  padding-right: 10px;
	  height: 40px;
	}
	.progressbar .inner {
	  height: 40px;
	  animation: progressbar-countdown;
	  /* Placeholder, this will be updated using javascript */
	  animation-duration: 40s;
	  /* We stop in the end */
	  animation-iteration-count: 1;
	  /* Stay on pause when the animation is finished finished */
	  animation-fill-mode: forwards;
	  /* We start paused, we start the animation using javascript */
	  animation-play-state: paused;
	  /* We want a linear animation, ease-out is standard */
	  animation-timing-function: linear;
	}
	@keyframes progressbar-countdown {
	  0% {
	    width: 100%;
	    background: #0F0;
	  }
	  100% {
	    width: 0%;
	    background: #F00;
	  }
	}

	.popup {
	  position: relative;
	  display: inline-block;
	  cursor: pointer;
	}

	/* The actual popup */
	.popup .popuptext {
	  visibility: hidden;
	  width: 240px;
	  background-color: #555;
	  color: #fff;
	  text-align: center;
	  border-radius: 6px;
	  padding: 8px 0;
	  position: absolute;
	  z-index: 1;
	  /*bottom: 0%;
	  left: 50%;*/
	  margin-left: -131px;
	  margin-top: 60px;
	}

	/* Popup arrow */
	.popup .popuptext::after {
	  content: "";
	  position: absolute;
	  top: -11%;
	  left: 50%;
	  transform: scaleY(-1);
	  margin-left: -5px;
	  border-width: 5px;
	  border-style: solid;
	  border-color: #555 transparent transparent transparent;
	}

	#qmark {
	  height: 30px;
	  padding-top: 20px;
	}

	a {
		color: #AFDCEB;
	}

	/* Toggle this class - hide and show the popup */
	.popup .show {
	  visibility: visible;
	  -webkit-animation: fadeIn 1s;
	  animation: fadeIn 1s;
	}

	/* Add animation (fade in the popup) */
	@-webkit-keyframes fadeIn {
	  from {opacity: 0;} 
	  to {opacity: 1;}
	}

	@keyframes fadeIn {
	  from {opacity: 0;}
	  to {opacity:1 ;}
	}
  </style>
</head>

<body onload="setDailySongVal()">
  <div class="container">
  	  <div class="container-row" style="border-bottom: solid;">
  	  	<div id="decades" style="font-sixe:20px; magin:auto;">
  	  		<a href="decades/2020s.html">2020s</a>
  	  	</div>
  	  	<div id="header" style="font-size:60px; margin:auto;">
  	  		<b>Melodle</b>
  	  	</div>
  	  </div>
	  <div class="container-row" id="main-section-1">
	  	<div class="switcher">
		  	<div id="playlist" style="font-size:22px; padding-top:10px;"><b>Current Playlist:</b><br/>Spotify's Most Streamed</div>
		  	<button id="setplaylist" onclick="uploadPlaylist()">Upload Playlist</button>
		</div>
		<div class="switcher">
		  <div class="popup">
		  	<img id="qmark" src="https://upload.wikimedia.org/wikipedia/commons/f/f8/Question_mark_alternate.svg" onclick="showPopup()">
		  	<span class="popuptext" id="myPopup">Use a site like <a href="https://www.soundiiz.com" target="_blank">Soundiiz</a> to convert your Spotify playlist to JSON, then upload it here for a custom Melodle game!</span>
		  </div>
	  <div class="songselectiongrid">
		  <form>
				<input class="form-input" id="songNum" type="number" min="1">
			</form>
			<div class="arrowbuttons">
			<button id="previous" class="arrowbutton" onclick="incrementSong(-1)"><</button><button id="next" class="arrowbutton" onclick="incrementSong(1)">></button>
		</div>
		</div>
		    <button id="setsong" class="setsong">Change Song</button>
		</div>
	  </div>

	  <div class="container-row" id="main-section-2">
	  	<table>
	  		<tr>
	  			<td id="x1" style="width:7%;"></td>
	  			<td id="guess1"></td>
	  		</tr>
	  		<tr>
	  			<td id="x2"></td>
	  			<td id="guess2"></td>
	  		</tr>
	  		  <tr>
	  			<td id="x3"></td>
	  			<td id="guess3"></td>
	  		</tr>
	  		<tr>
	  			<td id="x4"></td>
	  			<td id="guess4"></td>
	  		</tr>
	  		<tr>
	  			<td id="x5"></td>
	  			<td id="guess5"></td>
	  		</tr>
	  		<tr>
	  			<td id="x6"></td>
	  			<td id="guess6"></td>
	  		</tr>
	  	</table>
	  </div>

	  <div class="container-row" id="main-section-completed">
		<div id="completed-text"></div>
	  </div>

	    <div class="container-row" style="height:0%">
			<div id="embed-iframe"></div>
		</div>

		<div class="container-row" id="main-section-3">
			<form autocomplete="off">
			    <div class="autocomplete">
			      <input id="myInput" type="text" name="myInput" placeholder="Type a song name ...">
			    </div>
			</form>
			<button class="submit" onclick="checkAnswer()">Submit</button>
			<button class="skip" onclick="skip()">Skip</button>
		  </div>
	  
	    <div class="container-row" id="main-section-4">
	    <div id='progressbar'></div>
	    <button class="playBtn" id="playBtn">Play Clip</button>
	    </div>	
   	</div>

  <script src="https://open.spotify.com/embed-podcast/iframe-api/v1" async>
  </script>
  <script type="text/javascript">
  	var links = [];
  	var songs = [];
  	var timer = 1250;
  	var increment = 1000;
  	var guess = 1;
  	var songVal = -1;
    window.onSpotifyIframeApiReady = (IFrameAPI) => {
      const element = document.getElementById('embed-iframe');
      songVal = parseInt(document.getElementById('songNum').value) - 1;
      const options = {
        width: '0%',
        height: '200px'
      };
      const callback = (EmbedController) => {
        document.querySelectorAll('.setsong').forEach(
          setsong => {
            setsong.addEventListener('click', () => {
              resetHTML();
              songVal = parseInt(document.getElementById('songNum').value) - 1;
              //EmbedController.loadUri('links[songVal]');
              EmbedController.loadUri('spotify:episode:7makk4oTQel546B0PZlDM5');
            });
          });
        document.querySelectorAll('.playBtn').forEach(
          playBtn => {
            playBtn.addEventListener('click', () => {
              EmbedController.togglePlay();
              createProgressbar('progressbar', (timer/1000).toString() + 's');
              document.getElementById("playBtn").disabled = true;
              setTimeout(function() {
				    EmbedController.togglePlay();
				    EmbedController.loadUri(links[songVal]);
				    document.getElementById('progressbar').innerHTML = "";
				    document.getElementById("playBtn").disabled = false;
				}, timer);
            });
          })
      };

      IFrameAPI.createController(element, options, callback);
    };

    async function setDailySongVal() {
    	const firstDay = new Date('2023-04-16');
    	const rightNow = new Date();

    	const milli = rightNow - firstDay;
    	let minutes = Math.floor(milli / 60000);
		  let hours = Math.round(minutes / 60);
		  let days = Math.round(hours / 24);
    	document.getElementById('songNum').value = days;
    	document.getElementById('songNum').max = days;

    	const file = await fetch('https://raw.githubusercontent.com/CanterburyEgg/melodle/main/decades/startup-playlist.json');
    	var fileText = await file.text();
    	parseStringToJsonToArrays(fileText, false);

    	document.getElementById('setsong').click();
    	let tmpArr = songs.slice();
    	tmpArr = shuffle(tmpArr);
    	autocomplete(document.getElementById("myInput"), tmpArr);
    }

    function incrementSong(x) {
    	let tmpVal = Math.min(document.getElementById('songNum').max, Math.max(1, parseInt(document.getElementById('songNum').value) + x));
    	document.getElementById('songNum').value = tmpVal;
    	document.getElementById('setsong').click();
    }

    function showPopup() {
		  var popup = document.getElementById("myPopup");
		  popup.classList.toggle("show");
		}

    function uploadPlaylist() {
    	let input = document.createElement('input');
		  input.type = 'file';
		  input.onchange = _ => {
		  // you can use this method to get file and perform respective operations
		        let file = input.files[0];
		        let reader = new FileReader();

		        reader.readAsText(file);
		        var fileText = "";

		        reader.onload = function() {
		        	fileText = reader.result;

			        parseStringToJsonToArrays(fileText, true);

			        let tmpArr = songs.slice();
			        tmpArr = shuffle(tmpArr);
		        	autocomplete(document.getElementById("myInput"), tmpArr);
		        	document.getElementById('songNum').max = tmpArr.length;
		        	document.getElementById('songNum').value = 1;
		        	document.getElementById('playlist').innerHTML = "<b>Current Playlist:</b><br/>" + file.name.substr(0,file.name.indexOf('.json'));
		        	document.getElementById('setsong').click();
		        }
		    };
		  input.click();
    }

    function parseStringToJsonToArrays(str, rand) {
    	const fileJSON = JSON.parse(str.toString());

      links = [];
      songs = [];
      tmpArr = [];

      for (let i of fileJSON)
      {
      	if (i.trackLink)
      	{
      		tmpArr.push(i.title + " - " + i.artist + "|||" + i.trackLink.replace("\\/", "/"));
      	}
      }

      if (rand)
      {
	      tmpArr = shuffle(tmpArr);
      }
    	
    	for (let i = 0; i < tmpArr.length; i++)
    	{
    		songs.push(tmpArr[i].substr(0,tmpArr[i].indexOf("|||")));
    		links.push(tmpArr[i].substr(tmpArr[i].indexOf("|||")+3));
    	}
    }

    function shuffle(array) {
	  let currentIndex = array.length, randomIndex;

	  // While there remain elements to shuffle.
	  while (currentIndex != 0) {

	    // Pick a remaining element.
	    randomIndex = Math.floor(Math.random() * currentIndex);
	    currentIndex--;

	    // And swap it with the current element.
	    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
	  }

	  return array;
	}

    function resetHTML() {
		guess = 1;
        timer = 1250;
        increment = 1000;

    	for (let i = 1; i <= 6; i++)
    	{
      		document.getElementById('guess' + i).innerHTML = "";
			document.getElementById('x' + i).innerHTML = "";
    	}

    	document.getElementById('main-section-3').style.display = 'flex';
		  document.getElementById('main-section-4').style.display = 'flex';
		  document.getElementById('main-section-completed').style.display = 'none';
		  document.getElementsByTagName('iframe')[0].style.width = '0%';
		  document.getElementById('main-section-2').style.paddingBottom = '5%';
    }

    function createProgressbar(id, duration, callback) {
	  // We select the div that we want to turn into a progressbar
	  var progressbar = document.getElementById(id);
	  progressbar.className = 'progressbar';

	  // We create the div that changes width to show progress
	  var progressbarinner = document.createElement('div');
	  progressbarinner.className = 'inner';

	  // Now we set the animation parameters
	  progressbarinner.style.animationDuration = duration;

	  // Eventually couple a callback
	  if (typeof(callback) === 'function') {
	    progressbarinner.addEventListener('animationend', callback);
	  }

	  // Append the progressbar to the main progressbardiv
	  progressbar.appendChild(progressbarinner);

	  // When everything is set up we start the animation
	  progressbarinner.style.animationPlayState = 'running';
	}

	function displayCorrectSong() {
		document.getElementsByTagName('iframe')[0].style.width = '100%';
		document.getElementById('main-section-completed').style.display = 'flex';
		document.getElementById('main-section-3').style.display = 'none';
		document.getElementById('main-section-4').style.display = 'none';
		document.getElementById('main-section-2').style.paddingBottom = '82px';
		document.getElementById('main-section-completed').style.paddingBottom = '70px';
	}

	function checkForSimilarArtist(str1, str2) {
		var str1dashless = str1.substr(str1.lastIndexOf('-') + 2);
		var str2dashless = str2.substr(str2.lastIndexOf('-') + 2);

		var artists1 = str1dashless.split(",");
		var artists2 = str2dashless.split(",");

		for (let i = 0; i < artists1.length; i++)
		{
			if (artists1[i].charAt(0) == ' ')
				artists1[i] = artists1[i].substr(1);
		}

		for (let i = 0; i < artists2.length; i++)
		{
			if (artists2[i].charAt(0) == ' ')
				artists2[i] = artists2[i].substr(1);
		}

		for (let i = 0; i < artists1.length; i++)
		{
			if (artists2.includes(artists1[i]))
				return true;
		}

		for (let i = 0; i < artists2.length; i++)
		{
			if (artists1.includes(artists2[i]))
				return true;
		}

		return false;
	}

	function skip() {
		document.getElementById('myInput').value = "";
		document.getElementById('guess' + guess).innerHTML = "-- Skipped --";
		document.getElementById('x' + guess).innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Red_X.svg/1200px-Red_X.svg.png" style="width:25px; margin:auto;"></img>';
		if (guess == 6)
		{
			displayCorrectSong();
			document.getElementById('completed-text').innerHTML = "<b>Oh no!</b><br/>Better luck on the next Melodle!";
		}
		else
		{
			timer = timer + increment;
			increment = increment + 1000;
		    guess++;
		}
	}

    function checkAnswer() {
		input = document.getElementById('myInput').value;

		if (songs.includes(input))
		{
			document.getElementById('myInput').value = "";
			document.getElementById('guess' + guess).innerHTML = input;

			if (songs[songVal] == input)
			{
				displayCorrectSong();
				document.getElementById('x' + guess).innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Green_check.svg/1024px-Green_check.svg.png" style="width:25px; margin:auto;"></img>';
				document.getElementById('completed-text').innerHTML = '<b>Nailed it!</b><br/>You solved the Melodle in ' + ((timer-1000)/1000).toString() + ' second(s).';
			}
			else
			{
				if (checkForSimilarArtist(songs[songVal], input))
						document.getElementById('x' + guess).innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/OOjs_UI_icon_alert-yellow.svg/1200px-OOjs_UI_icon_alert-yellow.svg.png" style="width:25px; margin:auto;"></img>';
					else
						document.getElementById('x' + guess).innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Red_X.svg/1200px-Red_X.svg.png" style="width:25px; margin:auto;"></img>';

				if (guess == 6)
				{
					displayCorrectSong();
					document.getElementById('completed-text').innerHTML = "<b>Oh no!</b><br/>Better luck on the next Melodle!";
				}
				else
				{
					timer = timer + increment;
					increment = increment + 1000;
				    guess++;
				}
			}
		}
	}

    function autocomplete(inp, arr) {
	  /*the autocomplete function takes two arguments,
	  the text field element and an array of possible autocompleted values:*/
	  var currentFocus;
	  /*execute a function when someone writes in the text field:*/
	  inp.addEventListener("input", function(e) {
	      var a, b, i, val = this.value;
	      /*close any already open lists of autocompleted values*/
	      closeAllLists();
	      if (!val) { return false;}
	      currentFocus = -1;
	      /*create a DIV element that will contain the items (values):*/
	      a = document.createElement("DIV");
	      a.setAttribute("id", this.id + "autocomplete-list");
	      a.setAttribute("class", "autocomplete-items");
	      /*append the DIV element as a child of the autocomplete container:*/
	      this.parentNode.appendChild(a);
	      /*for each item in the array...*/
	      searchResults = 0;
	      for (i = 0; i < arr.length; i++) {
	        /*check if the item starts with the same letters as the text field value:*/
	      	if (val.length >= 2 && arr[i].toUpperCase().includes(val.toUpperCase())) {
	          /*create a DIV element for each matching element:*/
	          b = document.createElement("DIV");
	          index = arr[i].toUpperCase().indexOf(val.toUpperCase());
	          /*make the matching letters bold:*/
	          b.innerHTML = arr[i].substr(0,index);
	          b.innerHTML += "<strong>" + arr[i].substr(index, val.length) + "</strong>";
	          b.innerHTML += arr[i].substr(index+val.length);
	          /*insert a input field that will hold the current array item's value:*/
	          b.innerHTML += '<input type="hidden" value="' + arr[i] + '">';
	          /*execute a function when someone clicks on the item value (DIV element):*/
	              b.addEventListener("click", function(e) {
	              /*insert the value for the autocomplete text field:*/
	              inp.value = this.getElementsByTagName("input")[0].value;
	              /*close the list of autocompleted values,
	              (or any other open lists of autocompleted values:*/
	              closeAllLists();
	          });
	          a.appendChild(b);

	          searchResults++;
	          if (searchResults == 10)
	          	i = arr.length;
	        }
	      }
	  });
	  /*execute a function presses a key on the keyboard:*/
	  inp.addEventListener("keydown", function(e) {
	      var x = document.getElementById(this.id + "autocomplete-list");
	      if (x) x = x.getElementsByTagName("div");
	      if (e.keyCode == 40) {
	        /*If the arrow DOWN key is pressed,
	        increase the currentFocus variable:*/
	        currentFocus++;
	        /*and and make the current item more visible:*/
	        addActive(x);
	      } else if (e.keyCode == 38) { //up
	        /*If the arrow UP key is pressed,
	        decrease the currentFocus variable:*/
	        currentFocus--;
	        /*and and make the current item more visible:*/
	        addActive(x);
	      } else if (e.keyCode == 13) {
	        /*If the ENTER key is pressed, prevent the form from being submitted,*/
	        e.preventDefault();
	        if (currentFocus > -1) {
	          /*and simulate a click on the "active" item:*/
	          if (x) x[currentFocus].click();
	        }
	      }
	  });
	  function addActive(x) {
	    /*a function to classify an item as "active":*/
	    if (!x) return false;
	    /*start by removing the "active" class on all items:*/
	    removeActive(x);
	    if (currentFocus >= x.length) currentFocus = 0;
	    if (currentFocus < 0) currentFocus = (x.length - 1);
	    /*add class "autocomplete-active":*/
	    x[currentFocus].classList.add("autocomplete-active");
	  }
	  function removeActive(x) {
	    /*a function to remove the "active" class from all autocomplete items:*/
	    for (var i = 0; i < x.length; i++) {
	      x[i].classList.remove("autocomplete-active");
	    }
	  }
	  function closeAllLists(elmnt) {
	    /*close all autocomplete lists in the document,
	    except the one passed as an argument:*/
	    var x = document.getElementsByClassName("autocomplete-items");
	    for (var i = 0; i < x.length; i++) {
	      if (elmnt != x[i] && elmnt != inp) {
	      x[i].parentNode.removeChild(x[i]);
	    }
	  }
	}
	/*execute a function when someone clicks in the document:*/
	document.addEventListener("click", function (e) {
	    closeAllLists(e.target);
	});
	}
  </script>
</body>

</html>
